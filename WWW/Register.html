<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Postal Server</title>
    <link rel="stylesheet" href="authorization.css">
</head>
<body>
    <div id="containerMain">
        <h1>Регистрация</h1>
        <br><br><hr>
        <input id="txtUsername" type="text" name="username" placeholder="Имя пользователя" minlength="2" required />
        <br>
        <input id="txtUserpass" type="password" name="userpass" placeholder="Пароль" minlength="6" required />
        <br>
        <button type="submit" id="buttonSubmit" onclick="submitRegistration()">Продолжить</button>
        <br>
        <p>Вернуться к странице <a href="Logon.html">авторизации</a></p>
        <p class="fail" id="messageError">Пользователь с таким именем уже существует!</p>
    </div>
<script>
    function submitRegistration() {
        //------------------------------ Validation -------------------------------------

        if (txtUsername.value.length < 2 || txtUserpass.value.length < 6) {
            alert("Имя пользователя должно быть не короче 2 символов \n\r Пароль должен быть не короче 6 символов!")
            return false;
        }

        //-------------------------- send info on server --------------------------------
        txtUsername.disabled = true; txtUserpass.disabled = true; buttonSubmit.disabled = true
        buttonSubmit.innerText = "Ожидание ответа..."

        const response = fetch(`/processReg?username=${txtUsername.value}&userpass=${txtUserpass.value}`)

        response.then( async (response)=> {

            if (response.status === 200 && response.headers.get('Content-Type') === 'application/json') {
                const responseData = await response.json()

                if (responseData.result === 'exists') {

                    messageError.innerText = "Пользователь с таким именем уже существует!"
                    messageError.style.transition = ""
                    messageError.style.opacity = "1"

                    setTimeout( () => {
                        messageError.style.transition = "opacity .3s linear"
                        messageError.style.opacity = "0"
                    }, 3000 )

                    txtUsername.disabled = false; txtUserpass.disabled = false; buttonSubmit.disabled = false
                    buttonSubmit.innerText = "Продолжить"

                    return false;
                }
                if (responseData.result === 'success') {
                    containerMain.innerHTML =
                        `<p class="success">Имя пользователя: ${responseData.username}` +
                        `<br>Пароль: ${responseData.userpass}` +
                        `<br><br><a href="/Logon.html">Продолжить</a></p>`
                }

            } else {
                alert(`Status: ${response.status} \n\r RespText: ${response.statusText}`)
                window.location.href = "/Register.html"
            }
        })
    }

</script>
</body>
</html>